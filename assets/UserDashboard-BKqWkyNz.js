import{b as $,r as m,u as k,s as c,j as e}from"./index-BB-twZpJ.js";function A(){const{user:t}=$(),[u,D]=m.useState(null),[x,p]=m.useState([]),[P,g]=m.useState(!0),f=k();m.useEffect(()=>{if(!t){f("/login");return}console.log("UserDashboard mounting for user:",t.id),(async()=>{try{g(!0),console.log("Fetching profile for user:",t.id);const{data:i,error:a}=await c.from("profiles").select("*").eq("id",t.id).single();if(a)throw console.error("Profile fetch error:",a),a;if(i.role!=="user"){console.log("User role not matched, redirecting to provider dashboard"),f("/provider-dashboard");return}D(i),console.log("Profile fetched successfully:",i)}catch(i){console.error("Error fetching profile:",i)}finally{g(!1)}})(),h();const o=localStorage.getItem("refreshUserDashboard");o&&(console.log("Forced refresh triggered by flag:",o),localStorage.removeItem("refreshUserDashboard"),h()),console.log("Initializing subscription for user bookings");const l=S();return()=>{console.log("Cleaning up subscription"),l&&l()}},[t,f]);const h=async(r=3,o=1e3)=>{for(let l=0;l<r;l++)try{g(!0),console.log(`Fetching bookings for user: ${t.id} (Attempt ${l+1}/${r})`);const{data:i,error:a}=await c.from("bookings").select("id, user_id, provider_id, service_id, scheduled_date, status, detailedaddress, anymessage, created_at").eq("user_id",t.id).order("created_at",{ascending:!1});if(a)throw console.error("Error fetching bookings:",a),a;let n=i||[];if(n.length>0){const b=[...new Set(n.map(s=>s.provider_id).filter(Boolean))],v=[...new Set(n.map(s=>s.service_id).filter(Boolean))];let y={},j={};const d=[];b.length>0?d.push(c.from("profiles").select("id, full_name, email").in("id",b)):d.push(Promise.resolve({data:[],error:null})),v.length>0?d.push(c.from("services").select("id, title").in("id",v)):d.push(Promise.resolve({data:[],error:null}));const[w,N]=await Promise.all(d),B=w.data||[],_=w.error,U=N.data||[],E=N.error;_&&console.error("Error fetching providers for bookings:",_),E&&console.error("Error fetching services for bookings:",E),y=Object.fromEntries(B.map(s=>[s.id,s])),j=Object.fromEntries(U.map(s=>[s.id,s])),n=n.map(s=>({...s,provider:y[s.provider_id]||null,service:j[s.service_id]||null}))}console.log("Bookings fetched (enriched):",n),p(n);return}catch(i){console.error("Error fetching dashboard data:",i),p([]),l<r-1&&(console.log(`Retrying fetch after delay of ${o}ms...`),await new Promise(a=>setTimeout(a,o)))}finally{l===r-1&&g(!1)}},S=()=>{const r=c.channel(`user_bookings:${t.id}`).on("postgres_changes",{event:"*",schema:"public",table:"bookings",filter:`user_id=eq.${t.id}`},o=>{console.log("Booking update received:",o),h()}).on("broadcast",{event:"refresh_bookings"},o=>{console.log("Broadcast refresh received:",o),h()}).subscribe();return()=>r.unsubscribe()};return P?e.jsx("div",{className:"min-h-screen bg-gray-50 py-10 px-6 text-center",children:e.jsx("div",{className:"text-gray-600 text-lg",children:"Loading dashboard..."})}):!u||u.role!=="user"?e.jsx("div",{className:"min-h-screen bg-gray-50 py-10 px-6 text-center",children:e.jsx("div",{className:"text-red-600 text-lg",children:"Access denied. User role required."})}):e.jsx("div",{className:"min-h-screen bg-gray-50 py-10 px-4 sm:px-6",children:e.jsxs("div",{className:"max-w-4xl mx-auto",children:[e.jsx("h2",{className:"text-2xl sm:text-3xl font-bold mb-6 text-gray-800",children:"Your Dashboard"}),e.jsxs("div",{className:"bg-white p-4 sm:p-6 rounded-lg shadow-md border border-gray-100",children:[e.jsx("h3",{className:"text-lg sm:text-xl font-semibold mb-4 text-gray-700",children:"Your Bookings"}),x.length===0?e.jsx("div",{className:"text-gray-500 text-center py-6",children:"No bookings yet."}):e.jsx("div",{className:"grid grid-cols-1 gap-4 sm:gap-6",children:x.map(r=>e.jsx("div",{className:"border border-gray-200 rounded-lg p-4 bg-white hover:shadow-md transition-shadow duration-200",children:e.jsxs("div",{className:"flex flex-col sm:flex-row sm:justify-between sm:items-start gap-4",children:[e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"font-medium text-gray-900 text-base",children:r.service?.title||"Service"}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Provider: ",r.provider?.full_name||r.provider?.email||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:["Date: ",new Date(r.scheduled_date).toLocaleString()]}),r.detailedaddress&&e.jsxs("p",{className:"text-sm text-gray-600 mt-2 p-2 bg-blue-50 rounded border-l-4 border-blue-400",children:[e.jsx("strong",{children:"ðŸ“ Location:"})," ",r.detailedaddress]}),r.anymessage&&e.jsxs("p",{className:"text-sm text-gray-600 mt-2 p-2 bg-green-50 rounded border-l-4 border-green-400",children:[e.jsx("strong",{children:"ðŸ’¬ Message:"})," ",r.anymessage]})]}),e.jsx("div",{className:"flex items-center",children:e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium whitespace-nowrap ${r.status==="accepted"?"bg-green-100 text-green-800":r.status==="completed"?"bg-blue-100 text-blue-800":r.status==="cancelled"?"bg-red-100 text-red-800":"bg-yellow-100 text-yellow-800"}`,children:r.status.charAt(0).toUpperCase()+r.status.slice(1)})})]})},r.id))}),e.jsx("button",{onClick:()=>window.location.href="/services",className:"mt-6 w-full sm:w-auto bg-indigo-600 text-white py-2 px-4 rounded-lg hover:bg-indigo-700 transition",children:"Book a Service"})]})]})})}export{A as default};
