import{b as P,u as q,r as m,s as c,j as e,L as S}from"./index-BB-twZpJ.js";function U(){const{user:d}=P(),y=q(),[g,$]=m.useState(null),[E,D]=m.useState([]),[w,b]=m.useState([]),[R,j]=m.useState(!0),[A,k]=m.useState(!0);m.useEffect(()=>{sessionStorage.getItem("providerDashBoot")==="1"&&k(!1)},[]),m.useEffect(()=>{if(!d){y("/login");return}(async()=>{try{j(!0);const{data:o,error:r}=await c.from("profiles").select("*").eq("id",d.id).single();if(r)throw r;if($(o),o.role!=="provider"){y("/user-dashboard");return}}catch(o){console.error("Error fetching profile:",o)}finally{j(!1)}})()},[d,y]);const B=async(s=3,o=1e3)=>{for(let r=0;r<s;r++)try{j(!0),console.log(`Fetching data for provider: ${d.id} (Attempt ${r+1}/${s})`);const{data:i,error:t}=await c.from("services").select("*").eq("provider_id",d.id);if(t)throw t;D(i||[]);const{data:n,error:x}=await c.from("bookings").select("id, user_id, provider_id, service_id, scheduled_date, status, detailedaddress, anymessage, created_at").eq("provider_id",d.id).order("created_at",{ascending:!1});if(x)throw x;let l=n||[];if(l.length>0){const f=[...new Set(l.map(a=>a.user_id).filter(Boolean))],u=[...new Set(l.map(a=>a.service_id).filter(Boolean))];let _={},h={};if(f.length>0){const{data:a,error:p}=await c.from("profiles").select("id, full_name, email").in("id",f);p?console.error("Error fetching users for bookings:",p):a&&(_=Object.fromEntries(a.map(v=>[v.id,v])))}if(u.length>0){const{data:a,error:p}=await c.from("services").select("id, title").in("id",u);p?console.error("Error fetching services for bookings:",p):a&&(h=Object.fromEntries(a.map(v=>[v.id,v])))}l=l.map(a=>({...a,user:_[a.user_id]||null,service:h[a.service_id]||null}))}console.log("Bookings fetched for provider (enriched):",l),b(l);return}catch(i){console.error("Error fetching data:",i),r<s-1&&(console.log(`Retrying fetch after delay of ${o}ms...`),await new Promise(t=>setTimeout(t,o)))}finally{r===s-1&&j(!1)}};m.useEffect(()=>{if(g&&g.role==="provider"){let s=!0;B().finally(()=>{s&&k(!1),sessionStorage.setItem("providerDashBoot","1")});const o=c.channel(`bookings:provider:${d.id}`).on("postgres_changes",{event:"*",schema:"public",table:"bookings",filter:`provider_id=eq.${d.id}`},async r=>{if(console.log("Booking update received:",r),r.eventType==="INSERT"){const[i,t]=await Promise.all([c.from("profiles").select("id, full_name, email").eq("id",r.new.user_id).single(),c.from("services").select("id, title").eq("id",r.new.service_id).single()]),n=i.data,x=i.error,l=t.data,f=t.error;x&&console.error("Error fetching user data:",x),f&&console.error("Error fetching service data:",f),b(u=>{if(u.some(a=>a.id===r.new.id))return u;const h={...r.new,user:n||{full_name:"Unknown User"},service:l||{title:"Unknown Service"}};return console.log("Adding new booking to state:",h),[h,...u]})}else r.eventType==="UPDATE"&&b(i=>{const t=i.map(n=>n.id===r.new.id?{...n,...r.new,user:n.user,service:n.service}:n);return console.log("Updated bookings state:",t),t})}).on("broadcast",{event:"refresh_bookings"},r=>{console.log("Broadcast refresh received:",r),B()}).subscribe();return()=>{s=!1,o.unsubscribe()}}},[g,d]);const N=async(s,o)=>{try{const{error:r}=await c.from("bookings").update({status:o}).eq("id",s).eq("provider_id",d.id);if(r){console.error("Error updating booking status:",r),alert(`Failed to update booking status: ${r.message}`);return}b(t=>t.map(n=>n.id===s?{...n,status:o}:n)),alert(`Booking ${o} successfully`);const i=w.find(t=>t.id===s);if(i){const{error:t}=await c.from("notifications").insert([{recipient_id:i.user_id,title:`Booking ${o}`,content:`${i.provider?.full_name||"Provider"} has ${o} your booking for ${i.service?.title||"a service"} scheduled on ${i.scheduled_date?new Date(i.scheduled_date).toLocaleString():"N/A"}. New Booking Request ID: ${i.id}`,type:"booking_status",is_read:!1}]);t&&console.error("Error sending notification:",t)}}catch(r){console.error("Unexpected error updating booking status:",r),alert("Failed to update booking status due to an unexpected error")}};return A?e.jsx("div",{className:"min-h-screen bg-gray-50 py-10 px-4 sm:px-6 lg:px-8 text-center",children:e.jsx("div",{className:"text-gray-600 text-lg",children:"Loading dashboard..."})}):!g||g.role!=="provider"?e.jsx("div",{className:"min-h-screen bg-gray-50 py-10 px-4 sm:px-6 lg:px-8 text-center",children:e.jsx("div",{className:"text-red-600 text-lg",children:"Access denied. Provider role required."})}):e.jsx("div",{className:"min-h-screen bg-gray-50 py-10 px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"max-w-7xl mx-auto",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 gap-4",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-3xl font-bold text-gray-900",children:"Provider Dashboard"}),e.jsxs("p",{className:"text-gray-600 mt-1",children:["Welcome, ",g?.full_name||"Provider"]})]}),e.jsx(S,{to:"/addservice",className:"w-full sm:w-auto bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition font-medium text-center",children:"+ Add Service"})]}),e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-2 gap-8",children:[e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md border border-gray-100",children:[e.jsx("h2",{className:"text-2xl font-semibold mb-6 text-gray-900",children:"Your Services"}),E.length===0?e.jsxs("div",{className:"text-gray-500 text-center py-8",children:[e.jsx("p",{children:"No services added yet."}),e.jsx(S,{to:"/addservice",className:"text-green-600 hover:text-green-700 font-medium mt-2 inline-block",children:"Add your first service â†’"})]}):e.jsx("div",{className:"space-y-4",children:E.map(s=>e.jsxs("div",{className:"border-b border-gray-200 pb-4 last:border-b-0",children:[e.jsx("h3",{className:"font-semibold text-gray-900 text-lg",children:s.title}),e.jsx("p",{className:"text-gray-600 text-sm mt-1",children:s.description}),e.jsxs("p",{className:"text-green-600 font-semibold mt-2",children:["â‚¹",s.price]})]},s.id))})]}),e.jsxs("div",{className:"bg-white p-6 rounded-lg shadow-md border border-gray-100",children:[e.jsx("h2",{className:"text-2xl font-semibold mb-6 text-gray-900",children:"Booking Requests"}),w.length===0?e.jsx("div",{className:"text-gray-500 text-center py-8",children:e.jsx("p",{children:"No bookings yet."})}):e.jsx("div",{className:"space-y-4 max-h-96 overflow-y-auto",children:w.map(s=>e.jsxs("div",{className:"border border-gray-200 rounded-lg p-4 hover:shadow-md transition",children:[e.jsxs("div",{className:"flex justify-between items-start mb-2",children:[e.jsx("h3",{className:"font-semibold text-gray-900",children:s.service?.title||"Service"}),e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-medium ${s.status==="pending"?"bg-yellow-100 text-yellow-800":s.status==="accepted"?"bg-blue-100 text-blue-800":s.status==="completed"?"bg-green-100 text-green-800":"bg-red-100 text-red-800"}`,children:s.status})]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("strong",{children:"User:"})," ",s.user?.full_name||s.user?.email||"N/A"]}),e.jsxs("p",{className:"text-sm text-gray-600",children:[e.jsx("strong",{children:"Date:"})," ",new Date(s.scheduled_date).toLocaleString()]}),s.detailedaddress&&e.jsxs("p",{className:"text-sm text-gray-600 mt-2 p-2 bg-blue-50 rounded border-l-4 border-blue-400",children:[e.jsx("strong",{children:"ðŸ“ Address:"})," ",s.detailedaddress]}),s.anymessage&&e.jsxs("p",{className:"text-sm text-gray-600 mt-2 p-2 bg-green-50 rounded border-l-4 border-green-400",children:[e.jsx("strong",{children:"ðŸ’¬ Message:"})," ",s.anymessage]}),e.jsxs("div",{className:"mt-4 flex flex-wrap gap-2",children:[s.status==="pending"&&e.jsxs(e.Fragment,{children:[e.jsx("button",{onClick:()=>N(s.id,"accepted"),className:"flex-1 bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700 transition font-medium",children:"Accept"}),e.jsx("button",{onClick:()=>N(s.id,"cancelled"),className:"flex-1 bg-red-600 text-white px-3 py-2 rounded text-sm hover:bg-red-700 transition font-medium",children:"Reject"})]}),s.status==="accepted"&&e.jsx("button",{onClick:()=>N(s.id,"completed"),className:"w-full bg-indigo-600 text-white px-3 py-2 rounded text-sm hover:bg-indigo-700 transition font-medium",children:"Mark as Completed"})]})]},s.id))})]})]})]})})}export{U as default};
